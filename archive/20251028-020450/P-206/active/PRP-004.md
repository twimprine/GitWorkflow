# Project Requirements Plan (PRP)

## 1. Overview
- **Purpose:** Healthcheck Echo Server
- **Scope:** Minimal HTTP server with /healthz and /echo endpoints using stdlib only
- **In-Scope Components:** srv/echo.py, srv/echo.js
- **Out-of-Scope:** External dependencies, Persistent storage, Authentication/Authorization, TLS/HTTPS, Rate limiting beyond body size

## 2. Traceability
- **Source File(s):** srv/echo.js, srv/echo.py
- **User Stories Map:** 

- US-001: As an operator, I need a health check endpoint to monitor service availability

- US-002: As a client, I need to echo JSON payloads for testing connectivity

- US-003: As a developer, I need automated tests to verify server behavior


## 3. Architecture Summary

## 4. Interfaces (Application/Class)

### EchoServer (srv)
- Description: HTTP server providing health check and echo endpoints
- Responsibilities: Listen on configured PORT, Route requests to appropriate handlers, Enforce body size limits, Validate Content-Type headers
- Invariants: No global state maintained, No file system access, Stateless request handling
- Methods:


## 5. HTTP API
### 5.1 Endpoints
- **Base Port:** `8080`
- **Endpoints:**

#### GET /healthz
- **Summary:** Health check endpoint returning 200 OK when server is operational
- **Headers:** {}
- **Request Schema:** 
- **Response Schema(s):** 
- **Status Codes:** 200
- **Constraints:** No request body required, No authentication required

#### POST /echo
- **Summary:** Echo endpoint that returns the posted JSON payload
- **Headers:** {
  "Content-Type": "application/json"
}
- **Request Schema:** #/schemas/json/EchoRequest
- **Response Schema(s):** #/schemas/json/EchoResponse
- **Status Codes:** 200, 400, 413, 415
- **Constraints:** Request body must be valid JSON, Request body size <= 16KB, Content-Type must be application/json


### 5.2 Environment Variables

- `PORT` (default: `8080`) — TCP port for HTTP server to bind Must be numeric, range 1024-65535 recommended


## 6. Contracts

### C-001-HEALTHZ — Health Check Endpoint Contract
- **Preconditions:** Server is running, Port is accessible
- **Postconditions:** Returns HTTP 200 status, Response body may be empty or contain status message
- **Invariants:** Endpoint always returns 200 when server is operational, No side effects from health check requests
- **Rollback:** No rollback needed - read-only operation
- **Security Controls:** No authentication required, No sensitive data exposed
- **Validation Steps:** HTTP GET /healthz returns 200, Response time < 100ms

### C-002-ECHO — Echo Endpoint Contract
- **Preconditions:** Server is running, Request method is POST, Content-Type header is application/json, Request body is valid JSON, Request body size <= 16KB
- **Postconditions:** Returns HTTP 200 with same JSON payload, Returns HTTP 400 for invalid JSON, Returns HTTP 413 for oversized payload, Returns HTTP 415 for wrong Content-Type
- **Invariants:** Response JSON matches request JSON exactly, No data persistence or side effects, Body size limit strictly enforced
- **Rollback:** No rollback needed - stateless operation
- **Security Controls:** Body size limited to 16KB to prevent DoS, Content-Type validation prevents injection, No code execution or file system access
- **Validation Steps:** POST valid JSON returns same JSON, POST >16KB returns 413, POST without Content-Type returns 415

### C-003-ENV — Environment Configuration Contract
- **Preconditions:** PORT environment variable is numeric if set, PORT value is between 1024-65535 if set
- **Postconditions:** Server binds to specified PORT or 8080 default, Server logs startup port
- **Invariants:** Default port is 8080, Invalid PORT values cause startup failure
- **Rollback:** Stop server process
- **Security Controls:** No privileged ports (<1024) without explicit configuration
- **Validation Steps:** Server starts on PORT environment variable, Server starts on 8080 when PORT not set


## 7. Data Schemas
### 7.1 OpenAPI
```yaml
{
  "openapi": "3.0.0",
  "info": {
    "title": "Echo HTTP Server API",
    "version": "1.0.0",
    "description": "Minimal HTTP server with health check and echo endpoints"
  },
  "servers": [
    {
      "url": "http://localhost:8080",
      "description": "Default local server"
    }
  ],
  "paths": {
    "/healthz": {
      "get": {
        "summary": "Health check endpoint",
        "responses": {
          "200": {
            "description": "Server is healthy"
          }
        }
      }
    },
    "/echo": {
      "post": {
        "summary": "Echo JSON payload",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object"
              },
              "example": {
                "a": 1
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Echo successful",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object"
                }
              }
            }
          },
          "400": {
            "description": "Invalid JSON"
          },
          "413": {
            "description": "Payload too large (>16KB)"
          },
          "415": {
            "description": "Unsupported Media Type"
          }
        }
      }
    }
  }
}
```

---

## Appendix A — Consolidated PRP JSON (authoritative machine content)

```json
{
  "version": "1.0.0",
  "metadata": {
    "prp_id": "P-206-T-004",
    "feature": "Healthcheck Echo Server",
    "scope": "Minimal HTTP server with /healthz and /echo endpoints using stdlib only",
    "components": [
      "srv/echo.py",
      "srv/echo.js"
    ],
    "out_of_scope": [
      "External dependencies",
      "Persistent storage",
      "Authentication/Authorization",
      "TLS/HTTPS",
      "Rate limiting beyond body size"
    ],
    "created_at": "2025-01-10T00:00:00Z"
  },
  "tasks": [
    {
      "task": "P-206-T-001",
      "delegated_to": "python-developer",
      "objective": "Implement Python HTTP server with /healthz and /echo endpoints using stdlib only",
      "affected_components": [
        "srv/echo.py"
      ],
      "success_criteria": [
        "Server starts on PORT from environment (default 8080)",
        "/healthz returns 200 OK",
        "/echo accepts POST with JSON and returns same JSON",
        "Request body limited to 16KB with 413 response on overflow",
        "Content-Type validation enforced for /echo endpoint"
      ],
      "validation_tests": [
        {
          "id": "VT-001",
          "description": "Health endpoint returns 200 OK",
          "expected_result": "HTTP 200 status code from /healthz"
        },
        {
          "id": "VT-002",
          "description": "Echo endpoint returns posted JSON",
          "expected_result": "POST {\"a\":1} returns {\"a\":1}"
        },
        {
          "id": "VT-003",
          "description": "Body size limit enforced",
          "expected_result": "Request >16KB returns HTTP 413"
        }
      ],
      "supporting_user_stories": [
        {
          "id": "US-001",
          "description": "As an operator, I need a health check endpoint to monitor service availability"
        },
        {
          "id": "US-002",
          "description": "As a client, I need to echo JSON payloads for testing connectivity"
        }
      ],
      "effort": {
        "estimated_hours": 2,
        "complexity": "low"
      },
      "notes": "Use http.server module, no external dependencies"
    },
    {
      "task": "P-206-T-002",
      "delegated_to": "nodejs-developer",
      "objective": "Implement Node.js HTTP server with /healthz and /echo endpoints using stdlib only",
      "affected_components": [
        "srv/echo.js"
      ],
      "success_criteria": [
        "Server starts on PORT from environment (default 8080)",
        "/healthz returns 200 OK",
        "/echo accepts POST with JSON and returns same JSON",
        "Request body limited to 16KB with 413 response on overflow",
        "Content-Type validation enforced for /echo endpoint"
      ],
      "validation_tests": [
        {
          "id": "VT-004",
          "description": "Health endpoint returns 200 OK",
          "expected_result": "HTTP 200 status code from /healthz"
        },
        {
          "id": "VT-005",
          "description": "Echo endpoint returns posted JSON",
          "expected_result": "POST {\"a\":1} returns {\"a\":1}"
        },
        {
          "id": "VT-006",
          "description": "Body size limit enforced",
          "expected_result": "Request >16KB returns HTTP 413"
        }
      ],
      "supporting_user_stories": [
        {
          "id": "US-001",
          "description": "As an operator, I need a health check endpoint to monitor service availability"
        },
        {
          "id": "US-002",
          "description": "As a client, I need to echo JSON payloads for testing connectivity"
        }
      ],
      "effort": {
        "estimated_hours": 2,
        "complexity": "low"
      },
      "notes": "Use Node.js http module, no external dependencies"
    },
    {
      "task": "P-206-T-003",
      "delegated_to": "test-runner",
      "objective": "Execute validation tests for health, echo, and size limit functionality",
      "affected_components": [
        "srv/echo.py",
        "srv/echo.js"
      ],
      "success_criteria": [
        "Health check test passes with 200 status",
        "Echo test returns exact JSON payload",
        "Size limit test returns 413 for oversized payload",
        "All tests execute successfully for both Python and Node implementations",
        "Test coverage reaches 100%"
      ],
      "validation_tests": [
        {
          "id": "VT-007",
          "description": "Run health check test",
          "expected_result": "curl returns 200 from /healthz"
        },
        {
          "id": "VT-008",
          "description": "Run echo test",
          "expected_result": "curl returns {\"a\":1} from /echo"
        },
        {
          "id": "VT-009",
          "description": "Run size limit test",
          "expected_result": "curl returns 413 for 20KB payload"
        }
      ],
      "supporting_user_stories": [
        {
          "id": "US-003",
          "description": "As a developer, I need automated tests to verify server behavior"
        }
      ],
      "effort": {
        "estimated_hours": 1,
        "complexity": "low"
      },
      "notes": "Tests defined in feature specification"
    }
  ],
  "contracts": [
    {
      "id": "C-001-HEALTHZ",
      "title": "Health Check Endpoint Contract",
      "preconditions": [
        "Server is running",
        "Port is accessible"
      ],
      "postconditions": [
        "Returns HTTP 200 status",
        "Response body may be empty or contain status message"
      ],
      "invariants": [
        "Endpoint always returns 200 when server is operational",
        "No side effects from health check requests"
      ],
      "rollback": [
        "No rollback needed - read-only operation"
      ],
      "security": [
        "No authentication required",
        "No sensitive data exposed"
      ],
      "validation": [
        "HTTP GET /healthz returns 200",
        "Response time < 100ms"
      ]
    },
    {
      "id": "C-002-ECHO",
      "title": "Echo Endpoint Contract",
      "preconditions": [
        "Server is running",
        "Request method is POST",
        "Content-Type header is application/json",
        "Request body is valid JSON",
        "Request body size <= 16KB"
      ],
      "postconditions": [
        "Returns HTTP 200 with same JSON payload",
        "Returns HTTP 400 for invalid JSON",
        "Returns HTTP 413 for oversized payload",
        "Returns HTTP 415 for wrong Content-Type"
      ],
      "invariants": [
        "Response JSON matches request JSON exactly",
        "No data persistence or side effects",
        "Body size limit strictly enforced"
      ],
      "rollback": [
        "No rollback needed - stateless operation"
      ],
      "security": [
        "Body size limited to 16KB to prevent DoS",
        "Content-Type validation prevents injection",
        "No code execution or file system access"
      ],
      "validation": [
        "POST valid JSON returns same JSON",
        "POST >16KB returns 413",
        "POST without Content-Type returns 415"
      ]
    },
    {
      "id": "C-003-ENV",
      "title": "Environment Configuration Contract",
      "preconditions": [
        "PORT environment variable is numeric if set",
        "PORT value is between 1024-65535 if set"
      ],
      "postconditions": [
        "Server binds to specified PORT or 8080 default",
        "Server logs startup port"
      ],
      "invariants": [
        "Default port is 8080",
        "Invalid PORT values cause startup failure"
      ],
      "rollback": [
        "Stop server process"
      ],
      "security": [
        "No privileged ports (<1024) without explicit configuration"
      ],
      "validation": [
        "Server starts on PORT environment variable",
        "Server starts on 8080 when PORT not set"
      ]
    }
  ],
  "interfaces": {
    "http": [
      {
        "method": "GET",
        "path": "/healthz",
        "summary": "Health check endpoint returning 200 OK when server is operational",
        "headers": {},
        "status_codes": [
          200
        ],
        "constraints": [
          "No request body required",
          "No authentication required"
        ]
      },
      {
        "method": "POST",
        "path": "/echo",
        "summary": "Echo endpoint that returns the posted JSON payload",
        "headers": {
          "Content-Type": "application/json"
        },
        "request_schema_ref": "#/schemas/json/EchoRequest",
        "response_schema_refs": [
          "#/schemas/json/EchoResponse"
        ],
        "status_codes": [
          200,
          400,
          413,
          415
        ],
        "constraints": [
          "Request body must be valid JSON",
          "Request body size <= 16KB",
          "Content-Type must be application/json"
        ]
      }
    ],
    "code": [
      {
        "name": "EchoServer",
        "package": "srv",
        "description": "HTTP server providing health check and echo endpoints",
        "responsibilities": [
          "Listen on configured PORT",
          "Route requests to appropriate handlers",
          "Enforce body size limits",
          "Validate Content-Type headers"
        ],
        "invariants": [
          "No global state maintained",
          "No file system access",
          "Stateless request handling"
        ],
        "methods": [
          {
            "name": "handle_healthz",
            "params": "request",
            "returns": "Response(200)",
            "summary": "Handle health check requests",
            "preconditions": [
              "Request path is /healthz"
            ],
            "postconditions": [
              "Returns 200 status"
            ]
          },
          {
            "name": "handle_echo",
            "params": "request",
            "returns": "Response(200|400|413|415)",
            "summary": "Handle echo requests with JSON validation",
            "preconditions": [
              "Request path is /echo",
              "Request method is POST"
            ],
            "postconditions": [
              "Returns same JSON if valid",
              "Returns error status for invalid requests"
            ]
          },
          {
            "name": "validate_content_type",
            "params": "headers",
            "returns": "boolean",
            "summary": "Validate Content-Type is application/json",
            "preconditions": [
              "Headers object provided"
            ],
            "postconditions": [
              "Returns true if Content-Type matches",
              "Returns false otherwise"
            ]
          },
          {
            "name": "check_body_size",
            "params": "content_length",
            "returns": "boolean",
            "summary": "Check if body size is within 16KB limit",
            "preconditions": [
              "Content-Length header present"
            ],
            "postconditions": [
              "Returns true if size <= 16KB",
              "Returns false otherwise"
            ]
          }
        ]
      }
    ],
    "env": [
      {
        "name": "PORT",
        "default": "8080",
        "description": "TCP port for HTTP server to bind",
        "constraints": "Must be numeric, range 1024-65535 recommended"
      }
    ]
  },
  "schemas": {
    "openapi": {
      "openapi": "3.0.0",
      "info": {
        "title": "Echo HTTP Server API",
        "version": "1.0.0",
        "description": "Minimal HTTP server with health check and echo endpoints"
      },
      "servers": [
        {
          "url": "http://localhost:8080",
          "description": "Default local server"
        }
      ],
      "paths": {
        "/healthz": {
          "get": {
            "summary": "Health check endpoint",
            "responses": {
              "200": {
                "description": "Server is healthy"
              }
            }
          }
        },
        "/echo": {
          "post": {
            "summary": "Echo JSON payload",
            "requestBody": {
              "required": true,
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object"
                  },
                  "example": {
                    "a": 1
                  }
                }
              }
            },
            "responses": {
              "200": {
                "description": "Echo successful",
                "content": {
                  "application/json": {
                    "schema": {
                      "type": "object"
                    }
                  }
                }
              },
              "400": {
                "description": "Invalid JSON"
              },
              "413": {
                "description": "Payload too large (>16KB)"
              },
              "415": {
                "description": "Unsupported Media Type"
              }
            }
          }
        }
      }
    },
    "json": [
      {
        "$id": "https://example.com/schemas/echo-request.json",
        "schema": {
          "type": "object",
          "description": "Any valid JSON object for echo endpoint",
          "additionalProperties": true
        }
      },
      {
        "$id": "https://example.com/schemas/echo-response.json",
        "schema": {
          "type": "object",
          "description": "Same JSON object as received in request",
          "additionalProperties": true
        }
      }
    ]
  },
  "security": {
    "abuse_cases": [
      "DoS via large payload submission",
      "Memory exhaustion via rapid requests",
      "JSON injection attacks",
      "Header injection attacks"
    ],
    "findings": [
      {
        "id": "SEC-001",
        "description": "Potential DoS via unbounded request body size",
        "mitigations": [
          "Enforce 16KB body size limit",
          "Return 413 Payload Too Large for oversized requests",
          "Reject requests before reading full body"
        ]
      },
      {
        "id": "SEC-002",
        "description": "JSON injection or malformed payload attacks",
        "mitigations": [
          "Validate Content-Type header strictly",
          "Use stdlib JSON parser only",
          "Return 400 Bad Request for invalid JSON",
          "No code execution from JSON content"
        ]
      },
      {
        "id": "SEC-003",
        "description": "No authentication or authorization",
        "mitigations": [
          "Documented as out-of-scope",
          "Deploy behind authenticated proxy if needed",
          "Use network policies to restrict access"
        ]
      }
    ]
  },
  "testing": {
    "validation_steps": [
      "Start server with PORT=8090",
      "Execute curl GET http://localhost:8090/healthz",
      "Verify response status is 200",
      "Execute curl POST http://localhost:8090/echo with JSON {\"a\":1}",
      "Verify response body matches {\"a\":1}",
      "Execute curl POST with 20KB payload",
      "Verify response status is 413",
      "Stop server process",
      "Verify clean shutdown"
    ]
  },
  "deployment": {
    "container": {
      "base_image": "python:3.11-slim or node:20-slim",
      "working_dir": "/app",
      "copy": [
        "srv/echo.py or srv/echo.js"
      ],
      "expose": [
        8080
      ],
      "cmd": [
        "python srv/echo.py or node srv/echo.js"
      ]
    },
    "k8s": {
      "deployment": {
        "replicas": 2,
        "container": {
          "image": "echo-http:latest",
          "ports": [
            {
              "containerPort": 8080
            }
          ],
          "env": [
            {
              "name": "PORT",
              "value": "8080"
            }
          ],
          "livenessProbe": {
            "httpGet": {
              "path": "/healthz",
              "port": 8080
            },
            "initialDelaySeconds": 5,
            "periodSeconds": 10
          },
          "readinessProbe": {
            "httpGet": {
              "path": "/healthz",
              "port": 8080
            },
            "initialDelaySeconds": 3,
            "periodSeconds": 5
          }
        }
      },
      "service": {
        "type": "ClusterIP",
        "ports": [
          {
            "port": 80,
            "targetPort": 8080
          }
        ]
      }
    }
  },
  "traceability": {
    "links": [
      {
        "source_id": "US-001",
        "target_id": "P-206-T-001",
        "relation": "implements"
      },
      {
        "source_id": "US-001",
        "target_id": "P-206-T-002",
        "relation": "implements"
      },
      {
        "source_id": "US-002",
        "target_id": "P-206-T-001",
        "relation": "implements"
      },
      {
        "source_id": "US-002",
        "target_id": "P-206-T-002",
        "relation": "implements"
      },
      {
        "source_id": "US-003",
        "target_id": "P-206-T-003",
        "relation": "implements"
      },
      {
        "source_id": "P-206-T-001",
        "target_id": "VT-001",
        "relation": "validates"
      },
      {
        "source_id": "P-206-T-001",
        "target_id": "VT-002",
        "relation": "validates"
      },
      {
        "source_id": "P-206-T-001",
        "target_id": "VT-003",
        "relation": "validates"
      },
      {
        "source_id": "P-206-T-002",
        "target_id": "VT-004",
        "relation": "validates"
      },
      {
        "source_id": "P-206-T-002",
        "target_id": "VT-005",
        "relation": "validates"
      },
      {
        "source_id": "P-206-T-002",
        "target_id": "VT-006",
        "relation": "validates"
      },
      {
        "source_id": "P-206-T-003",
        "target_id": "VT-007",
        "relation": "validates"
      },
      {
        "source_id": "P-206-T-003",
        "target_id": "VT-008",
        "relation": "validates"
      },
      {
        "source_id": "P-206-T-003",
        "target_id": "VT-009",
        "relation": "validates"
      },
      {
        "source_id": "C-001-HEALTHZ",
        "target_id": "GET /healthz",
        "relation": "defines"
      },
      {
        "source_id": "C-002-ECHO",
        "target_id": "POST /echo",
        "relation": "defines"
      },
      {
        "source_id": "SEC-001",
        "target_id": "C-002-ECHO",
        "relation": "mitigates"
      },
      {
        "source_id": "SEC-002",
        "target_id": "C-002-ECHO",
        "relation": "mitigates"
      }
    ]
  }
}
```
